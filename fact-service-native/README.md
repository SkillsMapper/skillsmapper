# Fact Service - Native

This is a summary of [Chapter P3](../chapters/chp3.asciidoc)

## Services Used

* Cloud Run
* Cloud SQL
* Cloud Key Management
* Identity Platform

## Build Locally

Apply local .env:

```shell
set -a; source ../.env; set +a 
set -a; source .env; set +a
```

```shell
mvn spring-boot:run
```

## Pre-requisites

First follow the instructions in the [Setup](../setup/README.md) to get a project up and running.

## Enable APIs

Enable the additional APIs for the services used in this project:

```shell
gcloud services enable sqladmin.googleapis.com
gcloud services enable secretmanager.googleapis.com
```

## Create a Cloud SQL Instance

Create an environment variable to store the `INSTANCE_NAME` e.g. `facts-postgresql`:

```shell
INSTANCE_NAME='[INSTANCE_NAME]'
```

Create a new Cloud SQL instance:

```shell
gcloud sql instances create $INSTANCE_NAME \
    --database-version=POSTGRES_14 \
    --tier=$DATABASE_TIER \
    --region=$REGION \
    --availability-type=REGIONAL \
    --storage-size=$DISK_SIZE
```

## Create a Cloud SQL Database

Create an environment variable to store the `DATABASE_NAME` e.g. `facts`:

```shell
export DATABASE_NAME='[DATABASE_NAME]'
```

Create a new database:

```shell
gcloud sql databases create $DATABASE_NAME \
    --instance=$INSTANCE_NAME
```

## Create a Cloud SQL User

Create an environment variable to store the `FACT_SERVICE_USER` e.g. `fact-service-user` and a `FACT_SERVICE_PASSWORD`. I recommend using a password manager to generate a secure password.

```shell
export FACT_SERVICE_USER='[FACT_SERVICE_USER]'
export FACT_SERVICE_PASSWORD='[FACT_SERVICE_PASSWORD]'
```

Create a user for the instance with a username and password:

```shell
gcloud sql users create $FACT_SERVICE_USER \
    --instance=$INSTANCE_NAME \
    --password=$FACT_SERVICE_PASSWORD
```

### Allow connection from own network (optional)

To connect from your own network, you need to add a network to the instance. This is not required if you are connecting from the same network as the Cloud SQL instance.

```shell
gcloud sql instances patch $INSTANCE_NAME \
    --authorized-networks=$MY_IP
```

## Add Secrets to Secrets Manager

Create a secret in Secrets Manager to store the database password:

```shell    
gcloud secrets create $FACT_SERVICE_DB_PASSWORD_SECRET_NAME \
    --replication-policy=automatic \
    --data-file=<(echo $DATABASE_PASSWORD)
```

## Cloud Run

Create an environment variable to store the `FACT_SERVICE_NAME` e.g. `fact-service`:

```shell    
export FACT_SERVICE_NAME='[FACT_SERVICE_NAME]'
```

Deploy to Cloud Run:

```shell
gcloud run deploy $FACT_SERVICE_NAME --source . --env-vars-file=.env.yaml --allow-unauthenticated
```

## Create a Service Account

Create a service account:

```shell
gcloud iam service-accounts create $FACT_SERVICE_SERVICE_ACCOUNT_NAME \
    --description="Service account for ${FACT_SERVICE_NAME}"
```

Grant the service account the `Cloud SQL Client` role:

```shell
gcloud projects add-iam-policy-binding $PROJECT_ID \
--member=serviceAccount:$FACT_SERVICE_SERVICE_ACCOUNT_NAME@$PROJECT_ID.iam.gserviceaccount.com \
--role=roles/cloudsql.client
```

Grant the service account the `Secret Manager Secret Accessor` role:
```shell
gcloud secrets add-iam-policy-binding $FACT_SERVICE_DB_PASSWORD_SECRET_NAME \
--member=serviceAccount:$FACT_SERVICE_SERVICE_ACCOUNT_NAME@$PROJECT_ID.iam.gserviceaccount.com \
--role=roles/secretmanager.secretAccessor
```

## Connect to Cloud SQL

Update the Cloud Run service to connect to Cloud SQL and use the service account:

```shell
gcloud run services update $FACT_SERVICE_NAME \
    --service-account ${FACT_SERVICE_SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com \
    --add-cloudsql-instances ${PROJECT_ID}:${REGION}:${INSTANCE_NAME} \
    --update-secrets=DATABASE_PASSWORD=${FACT_SERVICE_DB_PASSWORD_SECRET_NAME}:latest
```

## Testing with Curl

Get the key:

```shell
curl -X POST \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}&grant_type=client_credentials" \
  https://oauth2.googleapis.com/token
```

## Identity Platform

From [https://cloud.google.com/run/docs/tutorials/identity-platform](https://cloud.google.com/run/docs/tutorials/identity-platform)

Enable the Identity Platform API:

```shell
gcloud services enable identityplatform.googleapis.com
```

Download the OAuth 2.0 Client ID:

```shell
gclo
```

## Database connection options

Private IP:
* via socket (internal)
* via Cloud SQL Proxy

Public IP:
* Connect via socket (internal only if not in authorised network)
* Connect via IP (if on authorised network)
* Connect via socket from authorised external network
* Connect via Cloud SQL Proxy (Cloud Run provides a proxy)

Requires Google Libraries:
* 



















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































]













































































































































































































































































































































































































































































































































































































































































































































































































