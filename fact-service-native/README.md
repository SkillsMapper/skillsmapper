# Fact Service - Native

This is a summary of [Chapter P3](../chapters/chp3.asciidoc)

## Build Locally

Apply local .env:

```shell
set -a; source .env; set +a
```

```shell
mvn spring-boot:run
```

## Pre-requisites

First follow the instructions in the [Setup](../setup/README.md) to get a project up and running.

## Enable APIs

Enable the additional APIs for the services used in this project:

```shell
gcloud services enable sqladmin.googleapis.com
gcloud services enable secretmanager.googleapis.com
```

## Create a Cloud SQL Instance

Create an environment variable to store the `INSTANCE_NAME` e.g. `facts-postgresql`:

```shell
INSTANCE_NAME='[INSTANCE_NAME]'
```

Create a new Cloud SQL instance:

```shell
gcloud sql instances create $INSTANCE_NAME \
    --database-version=POSTGRES_14 \
    --tier=$DATABASE_TIER \
    --region=$REGION \
    --availability-type=REGIONAL \
    --storage-size=$DISK_SIZE
```

## Create a Cloud SQL Database

Create an environment variable to store the `DATABASE_NAME` e.g. `facts`:

```shell
export DATABASE_NAME='[DATABASE_NAME]'
```

Create a new database:

```shell
gcloud sql databases create $DATABASE_NAME \
    --instance=$INSTANCE_NAME
```

## Create a Cloud SQL User

Create an environment variable to store the `FACT_SERVICE_USER` e.g. `fact-service-user` and a `FACT_SERVICE_PASSWORD`. I recommend using a password manager to generate a secure password.

```shell
export FACT_SERVICE_USER='[FACT_SERVICE_USER]'
export FACT_SERVICE_PASSWORD='[FACT_SERVICE_PASSWORD]'
```

Create a user for the instance with a username and password:

```shell
gcloud sql users create $FACT_SERVICE_USER \
    --instance=$INSTANCE_NAME \
    --password=$FACT_SERVICE_PASSWORD
```

### Allow connection from own network (optional)

To connect from your own network, you need to add a network to the instance. This is not required if you are connecting from the same network as the Cloud SQL instance.

```shell
gcloud sql instances patch $INSTANCE_NAME \
    --authorized-networks=$MY_IP
```

## Add Secrets to Secrets Manager

Create a secret in Secrets Manager to store the database password:

```shell    
gcloud secrets create fact-service-db-password \
    --replication-policy=automatic \
    --data-file=<(echo $FACT_SERVICE_PASSWORD)
```

## Cloud Run

Create an environment variable to store the `FACT_SERVICE_NAME` e.g. `fact-service`:

```shell    
export FACT_SERVICE_NAME='[FACT_SERVICE_NAME]'
```

Deploy to Cloud Run:

```shell
gcloud run deploy $FACT_SERVICE_NAME --source . --env-vars-file=.env.yaml --allow-unauthenticated
```

## Identity Platform

From [https://cloud.google.com/run/docs/tutorials/identity-platform](https://cloud.google.com/run/docs/tutorials/identity-platform)

Enable the Identity Platform API:

```shell
gcloud services enable identityplatform.googleapis.com
```

Download the OAuth 2.0 Client ID: 

```shell
gclo
```

## Connect to Cloud SQL

```shell
gcloud run services update $FACT_SERVICE_NAME \
    --service-account ${SERVICE_ACCOUNT}@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com \
    --add-cloudsql-instances ${GOOGLE_CLOUD_PROJECT}:${GOOGLE_CLOUD_REGION}:${CLOUD_SQL_INSTANCE_NAME} \
    --update-secrets CLOUD_SQL_CREDENTIALS_SECRET=${SECRET_NAME}:latest
```

## Database connection options

Private IP:
* via socket (internal)
* via Cloud SQL Proxy

Public IP:
* Connect via socket (internal only if not in authorised network)
* Connect via IP (if on autorised network)
* Connect via socket from authorised exteral network
* Connect via Cloud SQL Proxy (Cloud Run provides a proxy)

Requires Google Libraries:
* 



















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































]













































































































































































































































































































































































































































































































































































































































































































































































































